name: Build NekoBox APK

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release Tag (optional)"
        required: false
        default: ""

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.value }}
    steps:
      - name: Generate Cache Key
        id: cache-key
        run: echo "value=nekobox-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

  clone:
    name: Clone Repository
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: MatsuriDayo/NekoBoxForAndroid
          ref: main
          path: nekobox-source

      - name: Upload Source as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: nekobox-source/
          retention-days: 1

  libcore:
    name: Build Native Library
    runs-on: ubuntu-latest
    needs: [setup, clone]
    steps:
      - name: Download Source
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      - name: Rename Directory
        run: mv nekobox-source/* ./ && mv nekobox-source/.* ./ || true

      - name: Calculate Build Hashes
        run: |
          find buildScript libcore/*.sh 2>/dev/null | xargs cat | sha1sum > golang_status || echo "no_go_files" > golang_status
          git ls-files libcore 2>/dev/null | xargs cat | sha1sum > libcore_status || echo "no_libcore_files" > libcore_status

      - name: Cache LibCore
        id: cache-libcore
        uses: actions/cache@v4
        with:
          path: app/libs/libcore.aar
          key: libcore-${{ needs.setup.outputs.cache-key }}-${{ hashFiles('golang_status', 'libcore_status') }}
          restore-keys: |
            libcore-${{ needs.setup.outputs.cache-key }}-
            libcore-

      - name: Setup Go
        if: steps.cache-libcore.outputs.cache-hit != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build Native Library
        if: steps.cache-libcore.outputs.cache-hit != 'true'
        run: |
          chmod +x ./run
          ./run lib core

      - name: Upload LibCore Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libcore-build
          path: |
            app/libs/libcore.aar
            golang_status
            libcore_status
          retention-days: 1

  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: [setup, clone, libcore]
    steps:
      - name: Download Source
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      - name: Download LibCore
        uses: actions/download-artifact@v4
        with:
          name: libcore-build
          path: .

      - name: Setup Directory Structure
        run: |
          mv nekobox-source/* ./ && mv nekobox-source/.* ./ || true
          mkdir -p app/libs/
          cp -f libcore-build/app/libs/libcore.aar app/libs/ 2>/dev/null || echo "libcore.aar not found in cache"

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ needs.setup.outputs.cache-key }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-${{ needs.setup.outputs.cache-key }}-
            gradle-${{ runner.os }}-

      - name: Build APK
        env:
          BUILD_PLUGIN: none
        run: |
          # Create local.properties with Android SDK path
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          echo "ndk.dir=$ANDROID_HOME/ndk/25.0.8775105" >> local.properties
          
          # Make scripts executable
          chmod +x ./run
          chmod +x ./gradlew
          
          # Initialize gradle (if needed by the project)
          ./run init action gradle || echo "Gradle init completed or failed - continuing"
          
          # Build the APK
          ./gradlew app:assembleOssRelease --no-daemon --stacktrace

      - name: Find and List APKs
        run: |
          echo "=== Searching for APK files ==="
          find . -name "*.apk" -type f | while read file; do
            echo "Found APK: $file"
            ls -la "$file"
          done
          echo "=== APK search completed ==="

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NekoBox-APK
          path: |
            **/build/outputs/apk/**/*.apk
            **/build/outputs/bundle/**/*.aab
          retention-days: 30

  create-release:
    name: Create GitHub Release
    if: ${{ needs.setup.outputs.cache-key && github.event.inputs.release_tag != '' }}
    runs-on: ubuntu-latest
    needs: [setup, build]
    steps:
      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: NekoBox-APK
          path: release-files

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: NekoBox Build ${{ github.event.inputs.release_tag }}
          body: |
            Automated build of NekoBoxForAndroid
            - Source: https://github.com/MatsuriDayo/NekoBoxForAndroid
            - Build Date: ${{ fromJSON(needs.setup.outputs.cache-key).date }}
          files: release-files/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
